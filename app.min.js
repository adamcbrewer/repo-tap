var https=require("https"),http=require("http"),express=require("express"),fs=require("fs"),handlebars=require("handlebars"),crypto=require("crypto"),config=require("./config.js"),Client=require("./models/client.js"),server=express(),socketServer=http.createServer(server),io=require("socket.io").listen(socketServer),md5sum=crypto.createHash("md5"),App={_loop:!1,totalTimeoutRequests:0,totalRepoRequests:0,results:{commits:null,count:0},clients:{},clientCount:0,init:function(){this._createTimer()},createClient:function(e){this.clients[e.id]=e;this.clientCount++;console.log("\n-- The connected clients are: "+this.clientCount+"\n");this.checkForCommits(e)},destroyClient:function(e){this.clients[e]&&delete this.clients[e];this.clientCount--;console.log("\n-- The connected clients are: "+this.clientCount+"\n")},checkForCommits:function(e){this.results.commits!==null},sendCommitsToClient:function(e){},_timerFetch:function(){var e=config.repos.length,t=0;this.totalTimeoutRequests++;console.log("\n-- Total timeout requests: "+this.totalTimeoutRequests+"\n");for(t;t<e;t++){console.log("getting: "+config.repos[t]);this.totalRepoRequests++;App.getLatest({repo:config.repos[t]})}console.log("\n-- Total repository requests: "+this.totalRepoRequests+"\n")},_createTimer:function(){var e=1e4,t=this;console.log("LOG: Fetching first set of results");this._timerFetch();this._loop&&setInterval(function(){t._timerFetch.call(t)},e)},getAll:function(){console.log(this.results.commits)},getLatest:function(e){e=e||{};var t=this,n=e.repo;opts={host:"api.bitbucket.org",port:443,method:"GET",path:"/1.0/repositories/"+e.repo+"/changesets?limit="+1,auth:config.auth,headers:{"content-type":"application/json"}};https.request(opts,function(e){e.setEncoding("utf8");var r="",i={};e.on("data",function(e){r+=e}).on("end",function(){t.processResults(r,n)})}).end()},processResults:function(e,t){data=JSON.parse(e);data.repo=t||null;this.results.commits===null&&(this.results.commits={});var n=this.results.commits[t];n&&console.log("Stored Node: "+n.node,"Recent node: "+data.changesets[0].node);if(n&&n.node==data.changesets[0].node)console.log("we already have the latest");else{this.results.commits[data.repo]=data.changesets[0];this.constructTemplate("partials/commit.tmpl",data)}},constructTemplate:function(e,t){var n=this.loadTemplate(e);template=handlebars.compile(n),commits=[],numCommits=t.changesets.length,i=0;for(i;i<numCommits;i++){t.changesets[i].repoName=t.repo;commits.push(template(t.changesets[i]))}this.output("all changesets",{commits:commits.reverse()})},output:function(e,t){},loadTemplate:function(e){var t=fs.readFileSync("./view/"+e,"utf8",function(e,t){if(e)throw e;return t});return t}};server.listen(8888);socketServer.listen(8080);var publicDir=__dirname+"/public",assetsDir=publicDir+"/assets";server.use("/assets",express.static(assetsDir));server.get("/",function(e,t){var n=!1,r=App.loadTemplate("layout.tmpl"),i=handlebars.compile(r),s=i({stylesheets:[{href:"assets/css/reset.css"},{href:"assets/css/core.css"}],debug:n});App.getAll();t.send(s)});io.sockets.on("connection",function(e){e.emit("server msg",{msg:"Socket open"});App.createClient(new Client({socket:e}));e.on("disconnect",function(){App.destroyClient(e.id)})});App.init();