var https=require("https"),http=require("http"),config=require("./config.js"),express=require("express"),fs=require("fs"),handlebars=require("handlebars"),server=express(),socketServer=http.createServer(server),io=require("socket.io").listen(socketServer),app={bbOpts:{host:"api.bitbucket.org",port:443,method:"GET",path:"/1.0/repositories/adamcbrewer/tool-miner/changesets",auth:config.auth,headers:{"content-type":"application/json"}},latestResults:!1,init:function(e){this.socket=e},output:function(e,t){this.socket.emit(e,{results:t})},getChangesets:function(e){e=e||10;var t=this;if(this.latestResults)t.constructTemplate("partials/commit.tmpl",this.latestResults);else{this.bbOpts.path+="?limit="+e;https.request(this.bbOpts,function(e){e.setEncoding("utf8");var n="",r={};e.on("data",function(e){n+=e}).on("end",function(){r=JSON.parse(n);t.latestResults=r;t.constructTemplate("partials/commit.tmpl",r)})}).end()}},constructTemplate:function(e,t){var n=this.loadTemplate(e);template=handlebars.compile(n),commits=[],numCommits=t.changesets.length,i=0;for(i;i<numCommits;i++)commits.push(template(t.changesets[i]));this.output("all changesets",{commits:commits})},loadTemplate:function(e){var t=fs.readFileSync("./view/"+e,"utf8",function(e,t){if(e)throw e;return t});return t}};server.listen(8888);socketServer.listen(8887);var publicDir=__dirname+"/public",assetsDir=publicDir+"/assets";server.use("/assets",express.static(assetsDir));server.get("/",function(e,t){var n=!1,r=app.loadTemplate("layout.tmpl"),i=handlebars.compile(r),s=i({stylesheets:[{href:"assets/css/reset.css"},{href:"assets/css/core.css"}],scripts:[{href:""}],debug:n});t.send(s)});io.sockets.on("connection",function(e){e.emit("server msg",{msg:"Socket open"});app.init(e);app.getChangesets(null)});