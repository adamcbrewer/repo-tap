var https=require("https"),http=require("http"),config=require("./config.js"),express=require("express"),fs=require("fs"),handlebars=require("handlebars"),server=express(),socketServer=http.createServer(server),io=require("socket.io").listen(socketServer),app={opts:{host:"api.bitbucket.org",port:443,method:"GET",path:"/1.0/repositories/adamcbrewer/tool-miner/changesets?limit=2",auth:config.auth,headers:{"content-type":"application/json"}},latestResults:null,init:function(e){this.socket=e},output:function(e,t){this.socket.emit(e,{results:t})},getChangesets:function(){var e=this,t=null;https.request(this.opts,function(t){t.setEncoding("utf8");var n="",r={};t.on("data",function(e){n+=e}).on("end",function(){r=JSON.parse(n);e.latestResults=r;e.output("all changesets",r)})}).end()},render:function(e,t){return e(t)},loadTemplate:function(e){var t=fs.readFileSync("./view/"+e,"utf8",function(e,t){if(e)throw e;return t});return t}};server.listen(8888);socketServer.listen(8887);var publicDir=__dirname+"/public",assetsDir=publicDir+"/assets";server.use("/assets",express.static(assetsDir));server.get("/",function(e,t){var n=!1,r=app.loadTemplate("layout.tmpl"),i=handlebars.compile(r),s=i({copy:"s;kdflkjlkj",stylesheets:[{href:"assets/css/reset.css"},{href:"assets/css/core.css"}],scripts:[{href:""}],debug:n});t.send(s)});io.sockets.on("connection",function(e){e.emit("server msg",{msg:"Socket open"});app.init(e);app.getChangesets()});